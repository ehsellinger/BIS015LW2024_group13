---
title: "final_project analysis"
author: "carrie lu"
date: "2024-03-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

1.  Load Libraries
```{r}
library(ggplot2)
library(tidyverse)
library(janitor)
library(jpeg)
library(shiny)
library(shinydashboard)
library(naniar)
library(shinythemes)
library(RColorBrewer)
library(paletteer)
library(ggthemes)
library(dplyr)
library(viridis)
```

2.  Read in data:
```{r}
conservatory <- read_csv("data/conservatory_modified.csv") %>% clean_names()
conservation_status <- read_csv("data/species_data.csv") %>% clean_names()
```

3.  Look at data
```{r}
glimpse(conservatory)
names(conservatory)
glimpse(conservation_status$group)
names(conservation_status)
```
filter for plants
IUCN_Plants+Non_IUCN_Vascular_Plants
```{r}
filtered_data <- conservation_status %>%
  filter(group %in% c("IUCN_Plants", "Non_IUCN_Vascular_Plants"))%>%
  rename(scientific_name = binomial) %>%
  select(-common_name, -total_area,- small_range, -name_language, -datanam_area,-datanam_pct_area, -small_range, -iso_a3)%>%
  distinct()

  glimpse(conservatory)

conservatory_cleaned2 <- conservatory  %>%
  select(-latest_update,-synonym, -plant_source, -date_brought_in, -variety_hybrid, -accession_number) %>%
  filter(scientific_name != "NA") %>% 
  filter(genus != "NA") %>%
  filter(species != "NA") %>% 
  mutate(scientific_name = paste(genus, species, sep = " "))%>%
  filter(scientific_name != "Unknown") %>%
  filter(scientific_name != "NA") %>%
  distinct()

```

for the upload
```{r}
#write.csv(filtered_data, "plant_conservation.csv", row.names = FALSE)
#didn't work

#filtered_data2 <- conservation_status %>% filter(group %in% c("IUCN_Plants", "Non_IUCN_Vascular_Plants"))%>% mutate(scientific_name = binomial) %>% select(-common_name, -name_language, -binomial, -group, -iucn_id_no,-iso_a3)%>% distinct()

#write.csv(filtered_data2, "filtered_data2.csv", row.names = FALSE)
```

```{r}
#merge
merged_data <- merge(conservatory_cleaned2, filtered_data, by = "scientific_name")

nrow(conservatory_cleaned2)
nrow(filtered_data)
nrow(merged_data)

tail(merged_data)
names(merged_data)
head(merged_data)
```


```{r}
#counts of each IUCN category
table(merged_data$iucn_category)

```

```{r}
merged_data %>%
  mutate(match_status = case_when(
    native_country == wb_datanam ~ "Match",
    TRUE ~ "Mismatch"
  )) %>%
  count(match_status)
```
**(Native countries in the two datasets don't match)

```{r}
library(ggplot2)

# Filter merged_data for IUCN category "CR" and count occurrences of each family
cr_families <- merged_data %>%
  filter(iucn_category == "CR") %>%
  group_by(family) %>%
  summarise(count = n()) %>%
  top_n(10, wt = count) %>%
  arrange(desc(count))

cr_families

# Create the bar plot
ggplot(cr_families, aes(x = reorder(family, count), y = count)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  labs(title = "Top 10 Families for Critically Endangered (CR)",
       x = "Family",
       y = "Count") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


```{r}
ui <- fluidPage(
  titlePanel("Top 10 Families for each IUCN Category"),
  selectInput("x", "Select Taxon", 
              choices = c("Overall", "Critically Endangered", "Endangered", "Vulnerable",
                          "Near Threatened", "Least Concern", "Data Deficient")),
  plotOutput("plot", width = "600px", height = "500px")
)

# Define server logic
server <- function(input, output, session) {
  output$plot <- renderPlot({
    cr_families <- merged_data %>%
      filter(iucn_category == input$x) %>%
      group_by(family) %>%
      summarise(count = n()) %>%
      top_n(10, wt = count) %>%
      arrange(desc(count))
    
    # Create the bar plot
     ggplot(merged_data, aes(x = reorder(family, count), fill = family)) +
      geom_bar(data = cr_families, aes(y = count), stat = "identity", fill = "skyblue") +
      labs(title = paste("Top 10 Families for", input$x),
           x = "Family",
           y = "Count") +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))
  })
}
shinyApp(ui, server)

```


heat map?
```{r}

glimpse(merged_data)
merge_cleaned<- merged_data %>%
  rename(region=wb_datanam)%>%
  filter(wb_iso != "NA")%>% #remove regions that aren't countries
  select("iucn_category", "region") 

  # Define color palette
color_palette <- c("CR" = "red", "EN" = "orange", "VU" = "yellow", "NT" = "chartreuse", "LC" = "darkgreen", "DD" = "grey")


mapdata <- map_data("world")
mapdata <- left_join(mapdata, merge_cleaned, by="region")

# Create the plot
ggplot(mapdata, aes(x = long, y = lat, group = group)) +
  geom_polygon(aes(fill = iucn_category), color = "black") +
  scale_fill_manual(name = "IUCN Category", values = color_palette) +
  labs(x = "Longitude", y = "Latitude", title = "Map with IUCN Categories") +
  theme_minimal()

```

```{r}
legend_labels <- c(
  "CR" = "Critically Endangered", 
  "EN" = "Endangered", 
  "VU" = "Vulnerable", 
  "NT" = "Near Threatened", 
  "LC" = "Least Concern", 
  "DD" = "Data Deficient"
)

# Create the plot
ggplot(mapdata, aes(x = long, y = lat, group = group)) +
  geom_polygon(aes(fill = iucn_category), color = "black", alpha = 0.8) +
  scale_fill_manual(
    name = "IUCN Category", 
    values = color_palette, 
    breaks = names(color_palette), 
    labels = legend_labels
  ) +
  labs(
    x = "Longitude", 
    y = "Latitude", 
    title = "Map with IUCN Categories and Definitions"
  ) +
   theme_minimal()
```

